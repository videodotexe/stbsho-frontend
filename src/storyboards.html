<!DOCTYPE html>
	<head>
		<title>Storyboard Shower</title>

		<link href="css/storyboards.css" rel="stylesheet" />
	</head>

	<body>

		<script src="./js/apiurl.js"></script>
		<script src="./js/checkauth.js"></script>
		<script>
			const accessToken = window.sessionStorage.getItem("AccessToken");
			checkAuth()
			.catch(() => {
				window.location = "./index.html";
			})
			.then(username => {
				const pageTemplate = `
					<div id="main-layout">
						<div>
							<div id="menu">
								<div id="title">
									storyboard<br/>shower
								</div>
								<div id="user-bar">
									<div id="user-image">
										<img src="images/user.jpg"/>
									</div>
									<div id="user-name" class="global-regular-text-accent">
										${username}
									</div>
								</div>
								<div id="menu-list">
									<div><a href="">Storyboards</a></div>
									<div><a href="">Public profile</a></div>
									<div><a href="">Settings</a></div>
									<div><a href="">Logout</a></div>
								</div>
							</div>
						</div>
						<div id="content">
							<div id="header">
								<div class="global-h2">Storyboards</div>
								<a class="global-button global-button-accent global-icon-button">
									<img src="images/button_icons/plus.png">
									Upload
								</a>
							</div>
							<div id="storyboard-grid">
								
							</div>
						</div>
					</div>
				`;

				document.body.innerHTML = pageTemplate;
				const apiUrl = `https://04uc18437f.execute-api.eu-west-1.amazonaws.com/user/${username}/storyboards?authed=1`;
				const gridElem = document.getElementById("storyboard-grid");
				fetch(apiUrl, {
					headers: {
						"Authentication": accessToken,
					}
				})
				.then(res => res.json())
				.then(json => {
					const storyboards = json["storyboards"];
					for (let stbId in storyboards) {
						const stbData = storyboards[stbId];
						const stbElem = document.createElement("div");
						stbElem.innerHTML = `
							<div class="storyboard-placeholder">
								<img src="${stbData["thumbnails"]["single"]}" />
							</div>
							<div class="storyboard-description">
								<div class="global-h4">
									${stbData["title"]}
								</div>
								<div class="global-grey-text">
									${formatDate(stbData["createdAt"])}
								</div>
							</div>
						`;

						stbElem.onclick = showStbOverlay(username, stbId);
						gridElem.appendChild(stbElem);
					}
				});
			});

			function showStbOverlay(username, stbId) {

				function _inner() {
					
					// Show element ASAP even if empty for now
					const overlayElem = document.createElement("div");
					overlayElem.classList.add("global-overlay");
					overlayElem.style.top = `${document.documentElement.scrollTop}px`;
					const stbOverlayElem = document.createElement("div");
					stbOverlayElem.classList.add("storyboard-overlay");
					const overlayLeftElem = document.createElement("div");
					overlayLeftElem.classList.add("overlay-left");
					const overlayRightElem = document.createElement("div");
					overlayRightElem.classList.add("overlay-right");
					stbOverlayElem.appendChild(overlayLeftElem);
					stbOverlayElem.appendChild(overlayRightElem);
					overlayElem.appendChild(stbOverlayElem);
					document.body.appendChild(overlayElem);
					document.body.classList.add("global-no-scroll");

					// Fetch storyboard data
					const apiUrl = `https://04uc18437f.execute-api.eu-west-1.amazonaws.com/user/${username}/${stbId}`;
					console.log(apiUrl);
					fetch(apiUrl, {
						headers: {
							"Authentication": accessToken,
						}
					})
					.then(res => res.json())
					.then(stbData => {

						// Hide elements and set them up according storyboard's visibility.
						const publicToggleClass = stbData["public"] ? "" : "global-toggle-off";
						const linkEmbedOptClass = stbData["public"] ? "" : "global-greyed";

						overlayRightElem.innerHTML = `
							<div>
								<div class="header">
									<div class="global-h4">
										${stbData["title"]}
									</div>
									<a 
										class="global-button global-small-icon-button global-clear-button"
										id="js-stb-overlay-close-btn"
									>
										<img src="images/button_icons/cross.svg">
									</a>
								</div>
								<div class="global-description-text global-grey-text">
									Created on ${formatDate(stbData["createdAt"])}
								</div>
							</div>

							<div id="options-panel">

								<div class="option-block">
									<div class="option-upper-bar">
										<div>
											<div class="global-regular-text-accent">
												Public
											</div>
											<div class="global-description-text">
												Make the storyboard accessible to others
											</div>
										</div>
										<div>
											<div class="global-toggle ${publicToggleClass}" id="js-stb-public-toggle">
												<div></div>
											</div>
										</div>
									</div>
								</div>

								<div class="option-block ${linkEmbedOptClass}" id="js-link-option">
									<div class="option-upper-bar">
										<div>
											<div class="global-regular-text-accent">
												Link
											</div>
											<div class="global-description-text">
												Give this link to anyone
											</div>
										</div>
										<div>
											<a class="global-button global-small-icon-button" title="Copy link">
												<img src="images/button_icons/copy.svg">
											</a>
										</div>
									</div>
									<input 
										type="text" readonly="1"
										class="global-text-input global-mono-text global-grey-text" 
										value="https://d1bxsdz0n811yu.cloudfront.net/widget.html?stb=3bb85020-3dd6-4430-964b-f8705bcb6813"
									/>
								</div>

								<div class="option-block ${linkEmbedOptClass}" id="js-embed-option">
									<div class="option-upper-bar">
										<div>
											<div class="global-regular-text-accent">
												Embed
											</div>
											<div class="global-description-text">
												Paste this in your webpage
											</div>
										</div>
										<div>
											<a class="global-button global-small-icon-button" title="Copy code">
												<img src="images/button_icons/copy.svg">
											</a>
										</div>
									</div>
									<div class="global-text-input global-mono-text global-grey-text">
										&lt;iframe src=”https://d1bxsdz0n811yu.cloudfront.net/widget.html?stb=3bb85020-3dd6-4430-964b-f8705bcb6813” style="border: 0px; width: 800px; height: 450px;"&gt;&lt;/iframe&gt;
									</div>
								</div>

								<div class="option-block">
									<div class="option-upper-bar">
										<div>
											<div class="global-regular-text-accent">
												Description
											</div>
											<div class="global-description-text">
												A short text to describe the board
											</div>
										</div>
										<div>
											<a class="global-button global-small-icon-button" title="Edit description">
												<img src="images/button_icons/edit.svg">
											</a>
										</div>
									</div>
									<div class="global-text-input global-grey-text">
										${stbData["description"]}
									</div>
								</div>

								<div class="option-block">
									<div class="option-upper-bar">
										<div>
											<div class="global-regular-text-accent">
												Rename
											</div>
											<div class="global-description-text">
												Change the title of this stroyboard
											</div>
										</div>
										<div>
											<a class="global-button global-small-icon-button" title="Rename storyboard">
												<img src="images/button_icons/edit.svg">
											</a>
										</div>
									</div>
								</div>

								<div class="option-block">
									<div class="option-upper-bar">
										<div>
											<div class="global-regular-text-accent">
												Delete
											</div>
											<div class="global-description-text">
												Delete this storyboard permanently
											</div>
										</div>
										<div>
											<a class="global-button global-small-icon-button" title="Delete storyboard">
												<img src="images/button_icons/trashbin.svg">
											</a>
										</div>
									</div>
								</div>
							</div>
						`;
	
						// Add close logic to the dialog
						const stbOverlayCloseBtnElem = document.getElementById("js-stb-overlay-close-btn");
						stbOverlayCloseBtnElem.onclick = event => {
							document.body.classList.remove("global-no-scroll");
							overlayElem.remove();
						};

						const linkOptElem = document.getElementById("js-link-option");
						const embedOptElem = document.getElementById("js-embed-option");
						const publicToggleElem = document.getElementById("js-stb-public-toggle");
						
						publicToggleElem.onclick = () => {
							const apiUrl = `https://04uc18437f.execute-api.eu-west-1.amazonaws.com/user/${username}/${stbId}`;
							const patchData = {
								"public": !stbData["public"]
							}
							publicToggleElem.classList.add("global-greyed");
							fetch(apiUrl, {
								method: "PATCH",
								headers: {
									"Authentication": accessToken,
									"Content-Type": "application/json"
								},
								body: JSON.stringify(patchData)
							})
							.then(res => {
								publicToggleElem.classList.remove("global-greyed");
								if (!res.ok) {
									// TODO: Make this more decent
									throw new Error("Impossible to edit storyboard data!");
								} else {
									if(patchData["public"] == false){
										// Public -> OFF
										publicToggleElem.classList.add("global-toggle-off");
										linkOptElem.classList.add("global-greyed");
										embedOptElem.classList.add("global-greyed");
									} else {
										// Public -> ON
										publicToggleElem.classList.remove("global-toggle-off");
										linkOptElem.classList.remove("global-greyed");
										embedOptElem.classList.remove("global-greyed");
									}
									// Update the data locally
									stbData["public"] = patchData["public"];
								}
							})
						};
					});
				}

				return _inner;
			}

			function formatDate(isoDate) {
				const dateObj = new Date(isoDate);
				return dateObj.toLocaleDateString("en-US", {
					year: "numeric", month: "long", day: "numeric"
				});
			}
		</script>
	</body>
</html>